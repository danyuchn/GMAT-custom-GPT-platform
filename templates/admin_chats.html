{% extends "base.html" %}

{% block content %}
<div class="admin-panel">
    <h2><i class="fas fa-users-cog me-2"></i>管理员后台 - 聊天记录</h2>
    
    <div class="row mb-4">
        <div class="col-md-6">
            <h4 class="mb-3"><i class="fas fa-user-friends me-2"></i>选择用户</h4>
            <div class="list-group">
                {% for user in users %}
                <a href="{{ url_for('admin_chats', user_id=user.id) }}" 
                   class="list-group-item list-group-item-action {% if selected_user_id|int == user.id %}active{% endif %}">
                    <i class="fas fa-user me-2"></i>{{ user.username }} <small class="text-muted">({{ user.email }})</small>
                </a>
                {% endfor %}
            </div>
        </div>
        
        <div class="col-md-6">
            {% if selected_user_id %}
                <h4 class="mb-3"><i class="fas fa-comments me-2"></i>聊天记录列表</h4>
                {% if chats %}
                    <form action="{{ url_for('delete_chats') }}" method="post" id="delete-form">
                        <input type="hidden" name="user_id" value="{{ selected_user_id }}">
                        
                        <div class="mb-3">
                            <button type="submit" class="btn btn-danger" id="delete-selected">
                                <i class="fas fa-trash-alt me-1"></i>删除选中
                            </button>
                            <button type="button" class="btn btn-secondary" id="select-all">
                                <i class="fas fa-check-square me-1"></i>全选
                            </button>
                            <button type="button" class="btn btn-secondary" id="deselect-all">
                                <i class="fas fa-square me-1"></i>取消全选
                            </button>
                        </div>
                        
                        <div class="list-group">
                            {% for chat in chats %}
                            <div class="list-group-item">
                                <div class="form-check">
                                    <input class="form-check-input chat-checkbox" type="checkbox" name="chat_ids" value="{{ chat.id }}" id="chat-{{ chat.id }}">
                                    <label class="form-check-label" for="chat-{{ chat.id }}">
                                        <a href="{{ url_for('admin_chat_detail', chat_id=chat.id) }}" class="text-decoration-none">
                                            {% if chat.category == 'quant' %}
                                                <i class="fas fa-calculator me-1 text-primary"></i>
                                            {% elif chat.category == 'verbal' %}
                                                <i class="fas fa-book me-1 text-success"></i>
                                            {% elif chat.category == 'graph' %}
                                                <i class="fas fa-chart-line me-1 text-info"></i>
                                            {% endif %}
                                            {{ chat.category }} - {{ chat.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}
                                        </a>
                                    </label>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </form>
                {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>该用户没有聊天记录或所有聊天记录为空
                    </div>
                {% endif %}
                
                <div class="mt-4">
                    <a href="{{ url_for('analyze_user_questions', user_id=selected_user_id) }}" class="btn btn-primary">
                        <i class="fas fa-chart-pie me-1"></i>分析该用户问题
                    </a>
                </div>
            {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>请选择一个用户查看其聊天记录
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    document.getElementById('select-all').addEventListener('click', function() {
        document.querySelectorAll('.chat-checkbox').forEach(function(checkbox) {
            checkbox.checked = true;
        });
    });
    
    document.getElementById('deselect-all').addEventListener('click', function() {
        document.querySelectorAll('.chat-checkbox').forEach(function(checkbox) {
            checkbox.checked = false;
        });
    });
    
    document.getElementById('delete-form').addEventListener('submit', function(e) {
        const checkedBoxes = document.querySelectorAll('.chat-checkbox:checked');
        if (checkedBoxes.length === 0) {
            e.preventDefault();
            alert('请至少选择一条聊天记录');
            return false;
        }
        
        if (!confirm('确定要删除选中的 ' + checkedBoxes.length + ' 条聊天记录吗？此操作不可恢复！')) {
            e.preventDefault();
            return false;
        }
    });
</script>
{% endblock %}